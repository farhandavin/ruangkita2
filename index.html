<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruang Kita Berdua ðŸ’•</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Konfigurasi Kustom Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-cream': '#FFF7F0',
                        'brand-rose': {
                            'light': '#FFE4E1',
                            'DEFAULT': '#FFB6C1',
                            'dark': '#E06474',
                        },
                        'brand-teal': {
                            'light': '#E0F2F1',
                            'DEFAULT': '#B2DFDB',
                            'dark': '#4DB6AC',
                        },
                        'brand-text': '#5D4037',
                    },
                    keyframes: {
                        'pop-in': { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        'heartbeat': { '0%': { transform: 'scale(1)' }, '14%': { transform: 'scale(1.1)' }, '28%': { transform: 'scale(1)' }, '42%': { transform: 'scale(1.1)' }, '70%': { transform: 'scale(1)' } }
                    },
                    animation: {
                        'pop-in': 'pop-in 0.5s ease-out forwards',
                        'fade-in': 'fade-in 0.7s ease-in-out forwards',
                        'heartbeat': 'heartbeat 1.5s ease-in-out infinite'
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FFF7F0; }
        ::-webkit-scrollbar-thumb { background: #FFB6C1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #E06474; }
        .masonry-grid { column-gap: 1rem; }
        @media (min-width: 640px) { .masonry-grid { columns: 2; } }
        @media (min-width: 1024px) { .masonry-grid { columns: 3; } }
        .masonry-item { break-inside: avoid; margin-bottom: 1rem; }
        #loading-overlay { z-index: 100; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 9999px; font-weight: 500; color: #5D4037; transition: all 0.3s ease; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.5); color: #E06474; }
        .nav-link.active { background-color: white; color: #E06474; font-weight: 700; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; border-radius: 9999px; transition: background-color 0.2s; }
        .icon-btn:hover { background-color: #f0f0f0; }
        .btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 1rem;
            height: 1rem;
            margin-left: -0.5rem;
            margin-top: -0.5rem;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-brand-cream text-brand-text font-sans antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-brand-cream bg-opacity-90 flex flex-col items-center justify-center transition-opacity duration-500 z-[100]">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-brand-rose animate-heartbeat mb-4"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        <p id="loading-text" class="text-brand-rose-dark text-lg font-semibold">Memuat...</p>
    </div>

    <!-- Halaman Masuk Kata Sandi -->
    <div id="password-entry-container" class="fixed inset-0 bg-brand-cream flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-xl animate-pop-in">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-brand-rose-dark">Ruang Kita</h1>
                <p class="text-brand-text mt-2">Masukkan kata sandi rahasia untuk masuk.</p>
            </div>
            <div id="password-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
                <span class="block sm:inline"></span>
            </div>
            <form id="password-form">
                <div class="mb-4">
                    <label for="password" class="block text-brand-text text-sm font-bold mb-2">Kata Sandi Ruang</label>
                    <input type="password" id="password" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-brand-rose" required>
                </div>
                <div class="flex flex-col gap-2">
                    <button type="submit" id="enter-room-button" class="w-full bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full transition-colors">Masuk</button>
                </div>
            </form>
        </div>
    </div>


    <div id="app" class="flex flex-col md:flex-row min-h-screen opacity-0 transition-opacity duration-500 hidden">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-brand-rose-light w-full md:w-72 p-4 md:p-6 flex md:flex-col justify-between items-center md:items-stretch shadow-lg">
            <div>
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-brand-rose-dark">Ruang Kita</h1>
                    <p id="room-name-display" class="text-sm text-brand-text truncate font-semibold"></p>
                </div>
                <ul class="flex flex-row md:flex-col justify-center md:justify-start space-x-2 md:space-x-0 md:space-y-2">
                    <li><a href="#" class="nav-link active" data-page="dashboard"><span>Dashboard</span></a></li>
                    <li><a href="#" class="nav-link" data-page="gallery"><span>Galeri Kenangan</span></a></li>
                    <li><a href="#" class="nav-link" data-page="journal"><span>Jurnal Cinta</span></a></li>
                    <li><a href="#" class="nav-link" data-page="wishlist"><span>Wishlist Belanja</span></a></li>
                    <li><a href="#" class="nav-link" data-page="goals"><span>Impian Kita</span></a></li>
                </ul>
            </div>
            <div class="flex flex-col items-center">
                 <button id="back-to-home-button" class="mt-4 w-full bg-white hover:bg-gray-100 text-brand-rose-dark font-bold py-2 px-4 rounded-full transition-colors">Ganti Ruang</button>
            </div>
        </nav>

        <!-- Konten Utama -->
        <main class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
            <div id="dashboard" class="page"></div>
            <div id="gallery" class="page hidden"></div>
            <div id="journal" class="page hidden"></div>
            <div id="wishlist" class="page hidden"></div>
            <div id="goals" class="page hidden"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-white p-4 rounded-lg max-w-3xl max-h-[90vh] relative animate-pop-in">
            <button onclick="closeImageModal()" class="absolute -top-3 -right-3 bg-white text-brand-rose-dark rounded-full w-8 h-8 flex items-center justify-center text-2xl font-bold">&times;</button>
            <img id="modalImage" src="" alt="Kenangan diperbesar" class="rounded-md max-w-full max-h-[85vh]">
        </div>
    </div>
    <div id="date-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center animate-pop-in">
            <h2 class="text-xl font-bold text-brand-rose-dark mb-4">Kapan petualangan kalian dimulai?</h2>
            <p class="text-sm text-brand-text mb-4">Ini adalah ruang baru! Masukkan tanggal jadian kalian untuk memulai.</p>
            <input type="date" id="startDateInput" class="p-2 border border-brand-teal-DEFAULT rounded-lg w-full mb-4">
            <button id="saveStartDateButton" class="w-full bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full transition-colors">Simpan Tanggal</button>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm animate-pop-in">
            <h2 id="confirmation-title" class="text-xl font-bold text-brand-rose-dark mb-4">Anda Yakin?</h2>
            <p id="confirmation-message" class="text-sm text-brand-text mb-6">Aksi ini tidak dapat dibatalkan.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full transition-colors">Batal</button>
                <button id="confirm-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Hapus</button>
            </div>
        </div>
    </div>
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md animate-pop-in">
            <h2 class="text-xl font-bold text-brand-rose-dark mb-4">Unggah Kenangan Baru</h2>
            <img id="image-preview" src="" alt="Pratinjau gambar" class="rounded-lg w-full h-64 object-contain mb-4 bg-gray-100 hidden">
            <div id="upload-form">
                <div id="upload-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
                <input type="file" id="image-input" class="hidden" accept="image/*">
                <button type="button" id="select-image-button" class="w-full border-2 border-dashed border-brand-teal-DEFAULT p-6 rounded-lg text-brand-text mb-4">Klik untuk memilih gambar</button>
                <div class="mb-4">
                    <label for="caption-input" class="block text-brand-text text-sm font-bold mb-2">Keterangan (opsional)</label>
                    <input type="text" id="caption-input" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-brand-rose">
                </div>
                <div id="upload-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4 hidden">
                    <div id="upload-progress-bar" class="bg-brand-rose h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-upload-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors">Batal</button>
                    <button type="button" id="confirm-upload-button" class="bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-brand-rose/50" disabled>Unggah</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://juckseljfhkizktihdcp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1Y2tzZWxqZmhraXprdGloZGNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYzMDIsImV4cCI6MjA2ODU5MjMwMn0.5PzO7wZPZrw5Xf32SPiAgS4lgDzH5lggxgCVHqqpcq4';
        const GALLERY_BUCKET_NAME = 'galerry.image';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VARIABEL GLOBAL & ELEMENT UI ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const passwordEntryContainer = document.getElementById('password-entry-container');
        const appContainer = document.getElementById('app');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        
        let coupleId = null;
        let currentUserId = null;
        let selectedFile = null;
        let realtimeChannel = null;

        // --- FUNGSI UTAMA & ALUR APLIKASI ---
        function initialize() {
            let localUserId = localStorage.getItem('ruangKitaUserId');
            if (!localUserId) {
                localUserId = crypto.randomUUID();
                localStorage.setItem('ruangKitaUserId', localUserId);
            }
            currentUserId = localUserId;

            loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            passwordEntryContainer.classList.remove('hidden');
        }

        async function enterRoom(password) {
            const enterButton = document.getElementById('enter-room-button');
            setButtonLoading(enterButton, true);
            if (!password) {
                showPasswordError("Kata sandi tidak boleh kosong.");
                setButtonLoading(enterButton, false);
                return;
            }
            coupleId = password.trim().toLowerCase().replace(/\s+/g, '-');
            
            passwordEntryContainer.classList.add('hidden');
            loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            loadingOverlay.querySelector('p').textContent = "Mengecek ruang...";
            
            await checkAndSetupCoupleData();
            setButtonLoading(enterButton, false);
        }
        
        async function checkAndSetupCoupleData() {
            try {
                const { data, error } = await supabase
                    .from('couples')
                    .select('start_date')
                    .eq('id', coupleId)
                    .single(); 

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (!data) {
                    loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('date-modal').classList.remove('hidden');
                } else {
                    showApp(data.start_date);
                }
            } catch (error) {
                console.error("Error checking room:", error);
                showPasswordError("Terjadi kesalahan atau izin ditolak. Pastikan RLS sudah diatur.");
            }
        }

        function showApp(startDate) {
            loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            passwordEntryContainer.classList.add('hidden');
            appContainer.classList.remove('hidden', 'opacity-0');
            document.getElementById('room-name-display').textContent = `Ruang: ${coupleId}`;
            
            renderDashboard(startDate);
            setupUI();
            setupRealtimeListeners();
        }

        function setupUI() {
            setupNavLinks();
            setupUploadModal();
        }

        async function setupRealtimeListeners() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }
            
            realtimeChannel = supabase.channel(`public:all:${coupleId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'gallery_items', filter: `couple_id=eq.${coupleId}` }, () => fetchAndRenderGallery())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'journal_entries', filter: `couple_id=eq.${coupleId}` }, () => fetchAndRenderJournal())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'couple_goals', filter: `couple_id=eq.${coupleId}` }, () => fetchAndRenderGoals())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'wishlist_items', filter: `couple_id=eq.${coupleId}` }, () => fetchAndRenderWishlist())
                .subscribe();

            fetchAndRenderGallery();
            fetchAndRenderJournal();
            fetchAndRenderGoals();
            fetchAndRenderWishlist();
        }
        
        // --- FUNGSI FETCH & RENDER ---
        async function fetchAndRenderGallery() {
            const { data, error } = await supabase.from('gallery_items').select('*').eq('couple_id', coupleId).order('created_at', { ascending: false });
            if (error) console.error("Error fetching gallery:", error);
            else renderGalleryPage(data);
        }
        async function fetchAndRenderJournal() {
            const { data, error } = await supabase.from('journal_entries').select('*').eq('couple_id', coupleId).order('created_at', { ascending: false });
            if (error) console.error("Error fetching journal:", error);
            else renderJournalPage(data);
        }
        async function fetchAndRenderGoals() {
            const { data, error } = await supabase.from('couple_goals').select('*').eq('couple_id', coupleId).order('created_at', { ascending: true });
            if (error) console.error("Error fetching goals:", error);
            else renderGoalsPage(data);
        }
        async function fetchAndRenderWishlist() {
            const { data, error } = await supabase.from('wishlist_items').select('*').eq('couple_id', coupleId).order('created_at', { ascending: true });
            if (error) console.error("Error fetching wishlist:", error);
            else renderWishlistPage(data);
        }

        function renderDashboard(startDate) {
            const start = new Date(startDate);
            start.setUTCHours(0, 0, 0, 0);
            const now = new Date();
            now.setUTCHours(0, 0, 0, 0);
            const diffTime = now - start;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1;

            document.getElementById('dashboard').innerHTML = `<h2 class="text-3xl font-bold text-brand-rose-dark mb-6 animate-fade-in">Selamat Datang, Sayang!</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-md flex flex-col items-center justify-center text-center animate-pop-in" style="animation-delay: 0.2s;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-brand-rose animate-heartbeat mb-4"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><h3 class="text-lg font-semibold text-brand-text mb-2">Kita Telah Bersama Selama</h3><p class="text-4xl font-bold text-brand-rose-dark">${diffDays}</p><p class="text-sm text-gray-500 mt-1">hari yang indah!</p></div><div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md animate-pop-in" style="animation-delay: 0.4s;"><h3 class="text-xl font-bold text-brand-rose-dark mb-4">Kenangan Terbaru</h3><div id="dashboard-gallery-preview" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div></div></div>`;
        }

        function renderGalleryPage(images = []) {
            const galleryContainer = document.getElementById('gallery');
            galleryContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-brand-rose-dark">Galeri Kenangan Kita</h2>
                    <button id="open-upload-modal-button" class="bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full transition-colors">Unggah Foto</button>
                </div>
                <div id="gallery-grid" class="masonry-grid"></div>
            `;

            const galleryGrid = galleryContainer.querySelector('#gallery-grid');
            if (images.length === 0) {
                galleryGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">Belum ada kenangan. Yuk, unggah foto pertama kalian!</p>`;
            } else {
                galleryGrid.innerHTML = images.map(image => `
                    <div class="masonry-item bg-white rounded-lg p-3 shadow-md cursor-pointer group relative" onclick="showImageModal('${image.image_url}')">
                        <img src="${image.image_url}" class="rounded-md w-full" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/600x400/FFF7F0/E06474?text=Gagal+Muat';">
                        ${image.caption ? `<p class="text-sm mt-2 p-1">${image.caption}</p>` : ''}
                        <button onclick="event.stopPropagation(); window.confirmDelete('gallery', '${image.id}', '${image.image_url}')" class="absolute top-1 right-1 bg-white/70 text-red-500 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `).join('');
            }
            
            const dashboardPreview = document.getElementById('dashboard-gallery-preview');
            if(dashboardPreview){
                const previewImages = images.slice(0, 3);
                 if (previewImages.length > 0) {
                     dashboardPreview.innerHTML = previewImages.map(img => `<img src="${img.image_url}" onclick="showImageModal(this.src)" class="rounded-lg w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform">`).join('');
                 } else {
                     dashboardPreview.innerHTML = `<p class="text-sm text-gray-500 col-span-full">Belum ada foto di galeri.</p>`;
                 }
            }

            document.getElementById('open-upload-modal-button').addEventListener('click', () => {
                document.getElementById('upload-modal').classList.remove('hidden');
            });
        }

        function renderJournalPage(entries = []) {
            const container = document.getElementById('journal');
            container.innerHTML = `<h2 class="text-3xl font-bold text-brand-rose-dark mb-6">Jurnal Cinta Kita</h2><div class="bg-white p-6 rounded-2xl shadow-md mb-6"><h3 class="text-xl font-bold text-brand-rose-dark mb-4">Tulis Cerita Baru...</h3><textarea id="journalInput" class="w-full p-3 border border-brand-teal-DEFAULT rounded-lg focus:ring-2 focus:ring-brand-rose-dark" rows="4" placeholder="Apa yang kamu rasakan hari ini, sayang?"></textarea><button id="saveJournalButton" class="mt-4 bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full transition-colors">Simpan Cerita</button></div><div id="journalEntries" class="space-y-4"></div>`;
            const entriesContainer = container.querySelector('#journalEntries');
            if (entries.length === 0) {
                entriesContainer.innerHTML = `<p class="text-center text-gray-500">Belum ada cerita.</p>`;
            } else {
                entriesContainer.innerHTML = entries.map(entry => `<div id="journal-entry-${entry.id}" class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-brand-teal-dark transition-all"><div id="journal-view-${entry.id}"><p class="text-gray-700">${entry.text.replace(/\n/g, '<br>')}</p><p class="text-right text-xs text-gray-400 mt-2">Oleh: ...${(entry.author || 'anonim').slice(-6)}</p><div class="flex items-center justify-end mt-2 space-x-2"><p class="text-xs text-gray-500 flex-grow">${entry.created_at ? new Date(entry.created_at).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) : ''}</p><button class="icon-btn" onclick="window.toggleJournalEdit('${entry.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="icon-btn text-red-500" onclick="window.confirmDelete('journal', '${entry.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div></div><div id="journal-edit-${entry.id}" class="hidden"><textarea class="w-full p-2 border border-brand-teal rounded-lg">${entry.text}</textarea><div class="flex justify-end gap-2 mt-2"><button class="text-sm py-1 px-3 rounded-full bg-gray-200 hover:bg-gray-300" onclick="window.toggleJournalEdit('${entry.id}')">Batal</button><button class="text-sm py-1 px-3 rounded-full bg-brand-rose text-white hover:bg-brand-rose-dark" onclick="window.saveJournalEdit(this, '${entry.id}')">Simpan</button></div></div></div>`).join('');
            }
            const saveBtn = container.querySelector('#saveJournalButton');
            saveBtn.addEventListener('click', async () => {
                const input = container.querySelector('#journalInput'); 
                const text = input.value.trim(); 
                if (text) { 
                    setButtonLoading(saveBtn, true); 
                    const { error } = await supabase.from('journal_entries').insert({ text: text, author: currentUserId, couple_id: coupleId }); 
                    if (!error) {
                        input.value = ''; 
                        fetchAndRenderJournal();
                    }
                    setButtonLoading(saveBtn, false); 
                }
            });
        }
        function renderGoalsPage(goals = []) {
            const container = document.getElementById('goals');
            container.innerHTML = `<h2 class="text-3xl font-bold text-brand-rose-dark mb-6">Daftar Impian Kita Bersama</h2><div class="bg-white p-6 rounded-2xl shadow-md"><div id="goalsList" class="space-y-3"></div><div class="mt-6 flex gap-4"><input type="text" id="goalInput" class="flex-grow p-3 border border-brand-teal-DEFAULT rounded-lg" placeholder="Tulis impian baru..."><button id="addGoalButton" class="bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full">Tambah</button></div></div>`;
            const listContainer = container.querySelector('#goalsList');
            if (goals.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500">Ayo kita buat daftar impian pertama kita!</p>`;
            } else {
                listContainer.innerHTML = goals.map(goal => `<div class="flex items-center p-3 rounded-lg transition-colors ${goal.done ? 'bg-brand-teal-light' : ''}"><input type="checkbox" ${goal.done ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-brand-rose cursor-pointer focus:ring-brand-rose" onchange="window.toggleGoal('${goal.id}', this.checked)"><label class="ml-3 text-brand-text flex-grow ${goal.done ? 'line-through text-gray-400' : ''}">${goal.text}</label><button class="icon-btn text-red-500 ml-2" onclick="window.confirmDelete('goal', '${goal.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join('');
            }
            const addBtn = container.querySelector('#addGoalButton');
            addBtn.addEventListener('click', async () => {
                const input = container.querySelector('#goalInput'); 
                const text = input.value.trim(); 
                if (text) { 
                    setButtonLoading(addBtn, true); 
                    const { error } = await supabase.from('couple_goals').insert({ text: text, done: false, couple_id: coupleId }); 
                    if (!error) {
                        input.value = ''; 
                        fetchAndRenderGoals();
                    }
                    setButtonLoading(addBtn, false); 
                }
            });
        }
        function renderWishlistPage(items = []) {
            const container = document.getElementById('wishlist');
            container.innerHTML = `<h2 class="text-3xl font-bold text-brand-rose-dark mb-6">Wishlist Belanja Kita</h2><div class="bg-white p-6 rounded-2xl shadow-md"><div id="wishlistItems" class="space-y-3"></div><div class="mt-6 flex flex-col sm:flex-row gap-4"><input type="text" id="wishlistInput" class="flex-grow p-3 border border-brand-teal-DEFAULT rounded-lg" placeholder="Nama barang..."><input type="number" id="wishlistPriceInput" class="w-full sm:w-32 p-3 border border-brand-teal-DEFAULT rounded-lg" placeholder="Harga (opsional)"><button id="addWishlistItemButton" class="bg-brand-rose hover:bg-brand-rose-dark text-white font-bold py-2 px-4 rounded-full">Tambah</button></div></div>`;
            const itemsContainer = container.querySelector('#wishlistItems');
            if (items.length === 0) {
                itemsContainer.innerHTML = `<p class="text-center text-gray-500">Wishlist masih kosong. Ayo tambahkan sesuatu!</p>`;
            } else {
                itemsContainer.innerHTML = items.map(item => `
                    <div class="flex items-center p-3 rounded-lg transition-colors ${item.done ? 'bg-brand-teal-light' : ''}">
                        <input type="checkbox" ${item.done ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-brand-rose cursor-pointer focus:ring-brand-rose" onchange="window.toggleWishlistItem('${item.id}', this.checked)">
                        <div class="ml-3 flex-grow">
                            <label class="text-brand-text ${item.done ? 'line-through text-gray-400' : ''}">${item.text}</label>
                            ${item.price ? `<p class="text-xs text-brand-teal-dark font-semibold">Rp ${new Intl.NumberFormat('id-ID').format(item.price)}</p>` : ''}
                        </div>
                        <button class="icon-btn text-red-500 ml-2" onclick="window.confirmDelete('wishlist', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>
                `).join('');
            }
            const addBtn = container.querySelector('#addWishlistItemButton');
            addBtn.addEventListener('click', async () => {
                const textInput = container.querySelector('#wishlistInput');
                const priceInput = container.querySelector('#wishlistPriceInput');
                const text = textInput.value.trim();
                const price = priceInput.value ? parseFloat(priceInput.value) : null;
                if (text) {
                    setButtonLoading(addBtn, true);
                    const { error } = await supabase.from('wishlist_items').insert({ text, price, done: false, couple_id: coupleId });
                    if (!error) {
                        textInput.value = '';
                        priceInput.value = '';
                        fetchAndRenderWishlist();
                    }
                    setButtonLoading(addBtn, false);
                }
            });
        }
        
        // --- EVENT LISTENERS & HELPERS ---
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }
        const passwordErrorDiv = document.getElementById('password-error');
        function showPasswordError(message) {
            passwordErrorDiv.textContent = message; passwordErrorDiv.classList.remove('hidden'); loadingOverlay.classList.add('opacity-0', 'pointer-events-none'); passwordEntryContainer.classList.remove('hidden');
        }
        document.getElementById('password-form').addEventListener('submit', (e) => { e.preventDefault(); const password = document.getElementById('password').value; enterRoom(password); });
        document.getElementById('saveStartDateButton').addEventListener('click', async (e) => {
            const dateInput = document.getElementById('startDateInput').value; if (dateInput && coupleId) { setButtonLoading(e.target, true); await supabase.from('couples').insert({ id: coupleId, start_date: new Date(dateInput) }); document.getElementById('date-modal').classList.add('hidden'); showApp(dateInput); setButtonLoading(e.target, false); }
        });
        document.getElementById('back-to-home-button').addEventListener('click', () => { window.location.reload(); });

        function setupUploadModal() {
            const uploadModal = document.getElementById('upload-modal');
            const imageInput = document.getElementById('image-input');
            const selectImageButton = document.getElementById('select-image-button');
            const imagePreview = document.getElementById('image-preview');
            const captionInput = document.getElementById('caption-input');
            const confirmUploadButton = document.getElementById('confirm-upload-button');
            const cancelUploadButton = document.getElementById('cancel-upload-button');
            const uploadErrorDiv = document.getElementById('upload-error');
            
            selectImageButton.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                        selectImageButton.classList.add('hidden');
                        confirmUploadButton.disabled = false;
                    };
                    reader.readAsDataURL(selectedFile);
                }
            });

            cancelUploadButton.addEventListener('click', () => {
                uploadModal.classList.add('hidden');
                resetUploadForm();
            });

            confirmUploadButton.addEventListener('click', async () => {
                if (!selectedFile || !coupleId) return;

                setButtonLoading(confirmUploadButton, true);
                cancelUploadButton.disabled = true;
                uploadErrorDiv.classList.add('hidden');

                const fileExtension = selectedFile.name.split('.').pop();
                const fileName = `${crypto.randomUUID()}.${fileExtension}`;
                const filePath = `${coupleId}/${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from(GALLERY_BUCKET_NAME)
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    console.error("Upload failed:", uploadError);
                    showUploadError(`Unggah gagal: ${uploadError.message}`);
                    setButtonLoading(confirmUploadButton, false);
                    cancelUploadButton.disabled = false;
                    return;
                }

                const { data: { publicUrl } } = supabase.storage.from(GALLERY_BUCKET_NAME).getPublicUrl(filePath);

                const { error: insertError } = await supabase.from('gallery_items').insert({
                    image_url: publicUrl,
                    caption: captionInput.value.trim(),
                    uploader: currentUserId,
                    couple_id: coupleId
                });

                if (insertError) {
                     showUploadError(`Gagal menyimpan data: ${insertError.message}`);
                } else {
                    fetchAndRenderGallery();
                    uploadModal.classList.add('hidden');
                    resetUploadForm();
                }

                setButtonLoading(confirmUploadButton, false);
                cancelUploadButton.disabled = false;
            });

            function showUploadError(message) {
                uploadErrorDiv.textContent = message;
                uploadErrorDiv.classList.remove('hidden');
            }

            function resetUploadForm() {
                selectedFile = null; 
                imageInput.value = ''; 
                imagePreview.classList.add('hidden'); 
                imagePreview.src = ''; 
                selectImageButton.classList.remove('hidden'); 
                captionInput.value = ''; 
                confirmUploadButton.disabled = true;
                uploadErrorDiv.classList.add('hidden');
            }
        }

        // --- CRUD & HELPER FUNCTIONS ---
        window.toggleGoal = async (id, newStatus) => { await supabase.from('couple_goals').update({ done: newStatus }).eq('id', id); };
        window.toggleWishlistItem = async (id, newStatus) => { await supabase.from('wishlist_items').update({ done: newStatus }).eq('id', id); };
        window.toggleJournalEdit = (id) => { document.getElementById(`journal-view-${id}`).classList.toggle('hidden'); document.getElementById(`journal-edit-${id}`).classList.toggle('hidden'); };
        window.saveJournalEdit = async (button, id) => { 
            const editContainer = document.getElementById(`journal-edit-${id}`);
            const textarea = editContainer.querySelector('textarea');
            const newText = textarea.value.trim(); 
            if (newText) { 
                setButtonLoading(button, true);
                const { error } = await supabase.from('journal_entries').update({ text: newText }).eq('id', id); 
                setButtonLoading(button, false);
                if (!error) {
                    // [FIX] Panggil fungsi fetch lagi untuk memuat ulang daftar jurnal
                    fetchAndRenderJournal();
                } else {
                    console.error("Gagal menyimpan editan jurnal:", error);
                    // Jika gagal, kembalikan ke mode lihat
                    window.toggleJournalEdit(id);
                }
            } else {
                // Jika tidak ada teks, tutup saja mode edit
                window.toggleJournalEdit(id);
            }
        };
        window.confirmDelete = (type, id, url) => {
            const modal = document.getElementById('confirmation-modal'); const confirmBtn = document.getElementById('confirm-button'); const cancelBtn = document.getElementById('cancel-button');
            document.getElementById('confirmation-title').textContent = `Hapus ${type === 'gallery' ? 'Foto' : (type === 'journal' ? 'Cerita' : (type === 'wishlist' ? 'Wishlist' : 'Impian'))} Ini?`;
            document.getElementById('confirmation-message').textContent = 'Aksi ini tidak dapat dibatalkan.';
            modal.classList.remove('hidden');
            
            const confirmHandler = async () => {
                setButtonLoading(confirmBtn, true);
                let tableName;
                let refreshFunction;

                if (type === 'gallery') {
                    tableName = 'gallery_items';
                    refreshFunction = fetchAndRenderGallery;
                    if (url) {
                        try {
                            const filePath = new URL(url).pathname.split(`/${GALLERY_BUCKET_NAME}/`)[1];
                            await supabase.storage.from(GALLERY_BUCKET_NAME).remove([filePath]);
                        } catch(e) {
                            console.error("Could not parse file path from URL:", e);
                        }
                    }
                }
                else if (type === 'journal') {
                    tableName = 'journal_entries';
                    refreshFunction = fetchAndRenderJournal;
                }
                else if (type === 'goal') {
                    tableName = 'couple_goals';
                    refreshFunction = fetchAndRenderGoals;
                }
                else if (type === 'wishlist') {
                    tableName = 'wishlist_items';
                    refreshFunction = fetchAndRenderWishlist;
                }
                
                if (tableName) {
                    const { error } = await supabase.from(tableName).delete().eq('id', id);
                    if (!error) {
                        refreshFunction();
                    }
                }
                setButtonLoading(confirmBtn, false);
                closeConfirmModal();
            };
            
            const closeConfirmModal = () => {
                modal.classList.add('hidden'); 
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', closeConfirmModal);
            };
            
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', closeConfirmModal, { once: true });
        };
        function setupNavLinks() { navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = link.dataset.page; pages.forEach(page => page.classList.add('hidden')); document.getElementById(pageId).classList.remove('hidden'); navLinks.forEach(nav => nav.classList.remove('active')); link.classList.add('active'); }); }); }
        window.showImageModal = (src) => { document.getElementById('modalImage').src = src; document.getElementById('imageModal').classList.remove('hidden'); };
        window.closeImageModal = () => { document.getElementById('imageModal').classList.add('hidden'); };

        // --- MULAI APLIKASI ---
        initialize();
    
</script>
</body>
</html>
